---
title: '''jvm详解'''
date: 2020-02-18 15:20:04
categories: jvm
tags: jvm
---

**1.基本问题**
>* java内存区域（运行时数据区）
>* java对象创建过程
>* 对象的访问定位两种方式（句柄和直接指针）
>* String类和常量池

**2.运行时数据区**
>jdk1.8之前分为程序计数器、虚拟机栈、本地方法栈、堆、方法区（运行时常量池）、直接内存；
>jdk1.8之后分为程序计数器、虚拟机栈、本地方法栈、堆、直接内存（元空间）；
>以下详细说明：
>* 程序计数器：线程私有的较小内存空间，是当前线程执行字节码的信号指示器。字节码解释器工作时通过改变这个计数器的值来
>选取下一条需要执行的字节码指令；生命周期与线程相关，不会出现异常；
>* java虚拟机栈：线程私有，描述的是java方法执行的内存模型，每次方法调用的数据都是栈传递的，由一个个栈帧组成，每个栈帧
>都拥有：局部变量表、操作数栈、动态链接、方法出口信息； 局部变量表主要存放了编译器可知的各种基本数据类型和对象引用；
>生命周期与线程相关，由StackOverFlowError和OutOfMemoryError两种错误；
>* 本地方法栈：线程私有，和虚拟机栈作用类似，区别是：虚拟机栈为虚拟机执行java方法服务，而本地方法栈为虚拟机使用到的Native
>方法服务，本地方法被执行时，本地方法栈会创建一个栈帧，用于存放本地方法的局部变量表、操作数栈、动态链接、出口信息，方法执行
>完毕后相应的栈帧出栈并释放内存空间，会抛出错误；
>* 堆：线程共享，虚拟机启动时创建，此区域唯一目的是存放实例对象，几乎所有对象实例和数组都是在这里分配内存；通过-Xms和-Xmx
>调节；
>* 方法区：线程共享，用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等；通过-XX:PermSize和-XX:MaxPermSize
>调节，永久代是方法区的一种实现方式。jdk1.8之后被移除，取而代之的是元空间，使用直接内存，用-XX:MetaspaceSize和-XX:MaxMetaspaceSize
>调节；
>* 运行时常量池：是方法区的异步返，用于存储类中的常量池信息；jdk1.7之后在java堆中开辟了一块内存区域用于存放运行时常量池；
>* 直接内存：直接内存不是虚拟机运行时数据区的一部分，也不是虚拟机规范中定义的内存区域，但NIO等使用到，也会有OutOfMemoryError错误；

**3.对象创建过程**
>1. 类加载检查：虚拟机遇到new指令时，首先会检查这个指令的参数是否在常量池中定位到这个类的符号引用，并且检查符号引用代表的类是否已被
>加载过、解析和初始化。如果没有，必须先执行相应的类加载过程；
>2. 分配内存：类加载检查通过后，虚拟机会为新生对象分配内存。对象所需内存大小在类加载完成后可确定；java堆中分配方式有指针碰撞和空闲列表
>两种，选择方式由java堆是否规整决定，而java堆是否规整由垃圾收集器是否有压缩整理功能决定；
>3. 初始化零值；
>4. 设置对象头；
>5. 执行init方法；也就是初始化对象；

**4.对象的内存布局**
>Hotspot虚拟机中，对象在内存中分为三个区域：对象头、实例数据和对齐填充；
>对象头包含两部分信息：对象自身的运行时数据（哈希码、GC分代年龄、锁状态标志）和类型指针（指向它的类元数据的指针）；
>实例数据部分是对象真正存储的有效信息；
>对齐填充不是必然存在的，仅仅起占位作用；

**5.对象的访问定位**
>建立对象是为了使用，java程序通过栈上的引用数据类操作堆上具体对象，对象访问方式由虚拟机实现而定，主要有两种：使用句柄和直接指针；
>* 句柄：java堆中会划出一块内存作为句柄池，reference中存储的是对象的句柄地址，句柄中包含了对象实例数据与类型数据各自的具体地址信息；
>* 直接指针：对象实例数据中需要包含到对象类型的指针信息；
>* 句柄好处是reference中存储的是稳定的句柄地址，对象移动时reference本身不改变；直接指针好处是快；

**6.类加载过程**
>类加载class类型文件主要三步：加载——>连接（验证、准备、解析）——>初始化
>* 加载：1.通过全类名获取定义此类的二进制字节流；2.将字节流所代表的静态存储结构转换为方法区的运行时数据结构；3.在内存中生成一个代表该
>类的CLASS对象，作为方法区这些数据的访问入口；
>* 验证：文件格式验证、元数据验证、字节码验证、符号引用验证；
>* 准备：正式为类变量分配内存并设置类变量初始值的阶段；
>* 解析：虚拟机将常量池内的符号引用替换为直接引用的过程；
>* 初始化：执行类构造器<clinit>()方法的过程；